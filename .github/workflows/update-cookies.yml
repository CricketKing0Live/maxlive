name: Auto Update JioTV Cookies
on:
  schedule:
    - cron: '0 */6 * * *' # Every 6 hours (12:00 AM, 6:00 AM, 12:00 PM, 6:00 PM IST)
  workflow_dispatch: # Manual trigger
jobs:
  update-cookies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Fetch and Update Cookie
        run: |
          echo "Fetching JSON..."
          curl -s -f https://jo-json.vodep39240327.workers.dev/ > stream.json || {
            echo "ERROR: Failed to fetch JSON. Status: $?"
            exit 1
          }
          if [ ! -s stream.json ]; then
            echo "ERROR: JSON file is empty."
            exit 1
          fi
          if ! jq -e '.url' stream.json >/dev/null 2>&1; then
            echo "ERROR: url field not found."
            cat stream.json
            exit 1
          fi
          URL=$(jq -r '.url' stream.json)
          NEW_COOKIE=$(echo "$URL" | grep -oE '__hdnea__=[^& ]+' | cut -d'=' -f2- || echo "")
          if [ -z "$NEW_COOKIE" ]; then
            echo "ERROR: No __hdnea__ cookie found in URL."
            echo "URL: $URL"
            exit 1
          fi
          echo "Cookie: $NEW_COOKIE"
          if [ ! -f Jiotv.json ] || ! jq -e . Jiotv.json >/dev/null 2>&1; then
            echo '[{"cookie": ""}]' > Jiotv.json
            echo "Initialized Jiotv.json."
          fi
          jq --arg new_cookie "$NEW_COOKIE" 'map(.cookie = $new_cookie)' Jiotv.json > Jiotv_temp.json || {
            echo "ERROR: Failed to update Jiotv.json."
            cat Jiotv.json
            exit 1
          }
          mv Jiotv_temp.json Jiotv.json
          echo "Updated Jiotv.json with cookie: $NEW_COOKIE"
      - name: Commit and Push
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"
          git add Jiotv.json
          git commit -m "Update JioTV cookie ($(date -u '+%Y-%m-%d %H:%M:%S UTC'))" --no-verify --allow-empty || {
            echo "ERROR: Commit failed."
            git status
            exit 1
          }
          git push || {
            echo "ERROR: Push failed. Check GITHUB_TOKEN."
            git status
            exit 1
          }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
