name: Auto Update Zee5 Cookies (Fixed Path and Force Update Every 12 Hours)
on:
  schedule:
    - cron: '0 */12 * * *' # Every 12 hours (5:30 AM and 5:30 PM IST)
  workflow_dispatch: # Manual trigger
jobs:
  update-cookies:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main # Ensure we work on the main branch
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq
      - name: Fetch and Debug Cookie URL
        run: |
          echo "=== Fetching from https://doctor-strange.developed-for-wanda.workers.dev/ ==="
          curl -s https://doctor-strange.developed-for-wanda.workers.dev/ > stream.json
          if [ ! -s stream.json ]; then
            echo "✗ ERROR: Failed to fetch stream.json. File is empty."
            exit 1
          fi
          echo "File size: $(wc -c < stream.json) bytes"
          echo "Full stream.json preview (first 1000 chars):"
          head -c 1000 stream.json | tr -d '\n' | sed 's/"/\\"/g' | fold -w 80
          echo "Searching for JITENDRAUNATTI.ZEE5.Cookie..."
          if jq -e '.JITENDRAUNATTI.ZEE5.Cookie' stream.json >/dev/null 2>&1; then
            echo "✓ JITENDRAUNATTI.ZEE5.Cookie found in file!"
          else
            echo "✗ JITENDRAUNATTI.ZEE5.Cookie NOT found. Dumping first 200 lines:"
            head -n 200 stream.json
            exit 1
          fi
      - name: Extract Cookie and Update Zee5.json
        run: |
          echo "=== Extracting Cookie ==="
          # Extract cookie from JITENDRAUNATTI.ZEE5.Cookie
          NEW_COOKIE=$(jq -r '.JITENDRAUNATTI.ZEE5.Cookie' stream.json 2>/dev/null || echo "null")
          if [ "$NEW_COOKIE" = "null" ]; then
            echo "✗ ERROR: No valid cookie found in JITENDRAUNATTI.ZEE5.Cookie. Update skipped."
            echo "Raw stream.json content (first 200 lines):"
            head -n 200 stream.json
            exit 0
          fi
          echo "✓ Full cookie extracted: $NEW_COOKIE"

          echo "=== Updating Zee5.json ==="
          # Create backup or initialize Zee5.json if missing
          cp Zee5.json Zee5_backup.json 2>/dev/null || echo '[]' > Zee5_backup.json
          # Validate Zee5_backup.json
          if ! jq -e . Zee5_backup.json >/dev/null 2>&1; then
            echo "✗ WARNING: Zee5.json is invalid JSON. Initializing with empty array."
            echo '[]' > Zee5_backup.json
          fi
          # Update cookie field in Zee5.json (array of objects with cookie field)
          jq --arg new_cookie "$NEW_COOKIE" 'map(if .cookie then .cookie = $new_cookie else . + {"cookie": $new_cookie} end)' Zee5_backup.json > Zee5_updated.json
          mv Zee5_updated.json Zee5.json

          echo "✓ Update complete. New cookie: $NEW_COOKIE"
          echo "Preview of updated Zee5.json (first entry's cookie):"
          jq '.[0].cookie' Zee5.json 2>/dev/null || echo "No valid JSON to preview"
          echo "Full updated Zee5.json preview (first 200 chars):"
          head -c 200 Zee5.json

          # Check if Zee5.json changed
          if ! diff -q Zee5_backup.json Zee5.json >/dev/null 2>&1; then
            echo "✓ Zee5.json file changed!"
            touch .zee5-changed
          else
            echo "✓ No change in Zee5.json (same cookie or structure)."
          fi
      - name: Force Commit Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          # Commit if Zee5.json changed
          if [ -f .zee5-changed ]; then
            git add Zee5.json
            git commit -m "Auto-update Zee5 cookies in Zee5.json (new: ${{ github.sha }})" || {
              echo "✗ ERROR: Commit failed. Creating fallback commit."
              echo '{"update": "forced", "timestamp": "'$(date -u +%F_%T)'"}' > .force-commit.json
              git add .force-commit.json
              git commit -m "Fallback force update (new: ${{ github.sha }})"
            }
            git push || {
              echo "✗ ERROR: Git push failed. Check GITHUB_TOKEN or repo permissions."
              git status
              exit 1
            }
            echo "✓ Changes committed and pushed!"
          else
            echo "✓ No changes to commit. Skipping push."
          fi
          # Clean up temporary files
          rm -f stream.json Zee5_backup.json .zee5-changed .force-commit.json
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
